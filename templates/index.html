<!-- templates/index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>OpenManusX AIå¼€æ”¾å¹³å°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    height: 100vh;
    }

    .container {
        display: flex;
        height: 100vh;
    }

    /* å·¦ä¾§èµ„æºç®¡ç†å™¨ */
    .sidebar {
        width: 280px;
        background: #4ecdc4;
        border-right: 1px solid #dee2e6;
        padding: 20px;
        overflow-y: auto;
    }

    .file-tree {
        margin-top: 15px;
    }

    .folder {
        margin: 8px 0;
        cursor: pointer;
    }

    .file {
        margin: 5px 0 5px 20px;
        color: #495057;
        padding: 3px;
        border-radius: 3px;
    }

    .file:hover {
        background: #e9ecef;
    }

    /* ä¸­é—´å·¥ä½œåŒº */
    .workspace {
        flex: 1;
        background: white;
        padding: 15px;
    }

    .editor-header {
        display: flex;
        gap: 5px;
        margin-bottom: 10px;
    }

    .tab {
        padding: 8px 15px;
        background: #f1f3f4;
        border-radius: 5px 5px 0 0;
        cursor: pointer;
    }

    .tab.active {
        background: var(--secondary-color);
        color: block;
    }

    .code-editor {
        width: 100%;
        height: calc(80vh - 70px);
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        font-family: 'Consolas', monospace;
        font-size: 14px;
        resize: none;
    }

    /* å³ä¾§å¯¹è¯åŒº */
    .chat-panel {
        width: 600px;
        height: calc(102vh - 70px);
        background: white;
        border-left: 1px solid #dee2e6;
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
    }

    .content {
        max-width: 80%;
        padding: 10px 15px;
        border-radius: 12px;
    }


    .message {
        margin: 10px 0;
        padding: 10px;
        border-radius: 10px;
        max-width: 80%;
    }

    .message.ai {
        background: var(--ai-bubble);
        margin-right: auto;
    }

    .message.user {
        background: var(--user-bubble);
        margin-left: auto;
    }

    .chat-input {
        padding: 15px;
        border-top: 1px solid #dee2e6;
        display: flex;
        gap: 10px;
    }

    .chat-input input {
        flex: 1;
        padding: 8px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
    }

    .send-btn {
      /* åŸºç¡€æ ·å¼ */
      display: inline-block;
      padding: 12px 24px;
      border: none;
      border-radius: 25px;  /* æ§åˆ¶åœ†è§’ç¨‹åº¦ */
      background-color: #4CAF50;
      color: white;
      font-size: 16px;
      font-family: 'Arial', sans-serif;
      cursor: pointer;
      transition: all 0.3s ease;

      /* é˜´å½±æ•ˆæœ */
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* æ‚¬åœæ•ˆæœ */
    .send-btn:hover {
      background-color: #45a049;
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.2);
    }

    /* ç‚¹å‡»æ•ˆæœ */
    .send-btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* ç¦ç”¨çŠ¶æ€ */
    .send-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .header {
        text-align: center;
        margin-bottom: 10px;
        padding: 6px 0 10px;
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4); /* åŒè‰²å¯¹è§’çº¿æ¸å˜ */
    }

    </style>

    <script>

    // å‰ç«¯ä¿®æ”¹ (app.js)
    const FILE_ICONS = {
        // åŸºç¡€ç±»å‹
        'directory': 'ğŸ“',
        'default': 'ğŸ“„',

        // ç¼–ç¨‹è¯­è¨€
        '.py': 'ğŸ',       // Python
        '.js': 'ğŸš€',       // JavaScript
        '.ts': 'ğŸŸ¦',       // TypeScript
        '.java': 'â˜•',     // Java
        '.c': 'ğŸ”§',        // C
        '.cpp': 'ğŸ”©',      // C++
        '.cs': 'â“‚ï¸',      // C#
        '.go': 'ğŸ¹',       // Golang
        '.rs': 'ğŸ¦€',       // Rust

        // æ ‡è®°è¯­è¨€
        '.html': 'ğŸŒ',     // HTML
        '.htm': 'ğŸŒ',
        '.css': 'ğŸ¨',      // CSS
        '.scss': 'ğŸ€',     // SCSS
        '.less': 'ğŸŸ£',     // LESS
        '.md': 'ğŸ“',       // Markdown

        // æ•°æ®æ ¼å¼
        '.json': 'ğŸ“¦',     // JSON
        '.xml': 'ğŸ“œ',      // XML
        '.csv': 'ğŸ“Š',      // CSV
        '.xlsx': 'ğŸ“ˆ',     // Excel
        '.xls': 'ğŸ“‰',

        // æ–‡æ¡£
        '.doc': 'ğŸ“ƒ',      // Word
        '.docx': 'ğŸ“‘',
        '.ppt': 'ğŸ“½ï¸',     // PowerPoint
        '.pptx': 'ğŸï¸',
        '.pdf': 'ğŸ“š',      // PDF

        // åª’ä½“æ–‡ä»¶
        '.png': 'ğŸ–¼ï¸',      // å›¾ç‰‡
        '.jpg': 'ğŸŒ…',
        '.jpeg': 'ğŸŒ„',
        '.gif': 'ğŸ†',
        '.mp4': 'ğŸ¥',      // è§†é¢‘
        '.mp3': 'ğŸµ',      // éŸ³é¢‘

        // ç³»ç»Ÿæ–‡ä»¶
        '.exe': 'âš™ï¸',      // å¯æ‰§è¡Œæ–‡ä»¶
        '.bat': 'ğŸ–¥ï¸',      // æ‰¹å¤„ç†æ–‡ä»¶
        '.sh': 'ğŸ“Ÿ',       // Shellè„šæœ¬

        // å‹ç¼©åŒ…
        '.zip': 'ğŸ—œï¸',
        '.rar': 'ğŸ’',
        '.tar': 'ğŸ“¦',
        '.gz': 'â›‘ï¸',

        // é…ç½®æ–‡ä»¶
        '.yml': 'âš™ï¸',
        '.yaml': 'âš™ï¸',
        '.toml': 'âš™ï¸',
        '.ini': 'âš™ï¸',

        // å…¶ä»–
        '.sql': 'ğŸ—ƒï¸',      // æ•°æ®åº“
        '.log': 'ğŸ“°',      // æ—¥å¿—æ–‡ä»¶
        '.lock': 'ğŸ”’'      // é”å®šæ–‡ä»¶
    };
    let isProcessing = false;  // å…¨å±€çŠ¶æ€è·Ÿè¸ª

        document.addEventListener('DOMContentLoaded', () => {
            // æ–‡ä»¶ç³»ç»Ÿæ“ä½œ
            let currentFile = 'new_file.py';

            // åˆå§‹åŒ–æ–‡ä»¶æ ‘
            async function loadFileTree() {
                try {
                    const response = await fetch('/api/files');
                    const data = await response.json();
                    renderFileTree(data, document.querySelector('.file-tree'));
                } catch (error) {
                    console.error('åŠ è½½æ–‡ä»¶æ ‘å¤±è´¥:', error);
                }
            }

            // æ¸²æŸ“æ–‡ä»¶æ ‘
            function renderFileTree(tree, container) {
                container.innerHTML = tree.map(item => `
                    <div class="${item.type === 'directory' ? 'folder' : 'file'}"
                         data-path="${item.path || ''}">
                        ${item.type === 'directory' ? 'ğŸ“' : FILE_ICONS[item.ext]  || FILE_ICONS.default } ${item.name}
                        ${item.type === 'directory' ?
                            `<div class="children">${renderFileTree(item.children, document.createElement('div'))}</div>` : ''}
                    </div>
                `).join('');

                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                container.querySelectorAll('.file').forEach(item => {
                    item.addEventListener('click', async () => {
                        const path = item.dataset.path;
                        const response = await fetch('/api/file', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ path: path })
                        });
                        const data = await response.json();
                        document.querySelector('.code-editor').value = data.content;
                        currentFile = path;
                        document.querySelector('.tab.active').textContent = path;
                    });
                });
            }

            // ä¿å­˜æ–‡ä»¶
            window.saveFile = async () => {
                const content = document.querySelector('.code-editor').value;
                try {
                    await fetch('/api/save', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            path: currentFile,
                            content: content
                        })
                    });
                    await loadFileTree();
                    alert('ä¿å­˜æˆåŠŸï¼');
                } catch (error) {
                    console.error('ä¿å­˜å¤±è´¥:', error);
                }
            }

            // èŠå¤©åŠŸèƒ½
            const chatInput = document.querySelector('.chat-input input');
            const chatMessages = document.querySelector('.chat-messages');

            // ä¿®æ”¹åçš„æ¶ˆæ¯å‘é€å‡½æ•°
            window.sendMessage = async () => {

                if (isProcessing) return;  // é˜²æ­¢é‡å¤æäº¤
                const sidebar = document.querySelector('.sidebar');
                // ç¦ç”¨ç›¸å…³ç»„ä»¶
                isProcessing = true;
                sidebar.style.pointerEvents = 'none';
                sidebar.style.opacity = '0.5';

                const input = document.getElementById('message-input');
                const message = input.value.trim();
                if (!message) return;

                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                const chatBox = document.querySelector('.chat-messages');
                chatBox.innerHTML += `
                    <div class="message user">
                        <img src="/static/user-avatar.png" class="avatar">
                        <div class="content">${message}</div>
                    </div>
                `;

                // æ·»åŠ æœºå™¨äººæ¶ˆæ¯å®¹å™¨
                const botMessageDiv = document.createElement('div');
                botMessageDiv.className = 'message ai';
                botMessageDiv.innerHTML = `
                    <img src="/static/robot-avatar.png" class="avatar">
                    <div class="content" id="bot-response"></div>
                `;
                chatBox.appendChild(botMessageDiv);

                // æ»šåŠ¨åˆ°åº•éƒ¨
                chatBox.scrollTop = chatBox.scrollTop + 1000;

                try {

                    const response = await fetch('/api/chat-stream', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ message: message })
                    });

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let responseContent = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        responseContent += chunk;

                        // æ›´æ–°æ˜¾ç¤ºå†…å®¹
                        document.getElementById('bot-response').innerHTML =
                            responseContent.replace(/\n/g, '<br>');

                        // è‡ªåŠ¨æ»šåŠ¨
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }

                    input.value = '';

                } catch (error) {
                    console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                    document.getElementById('bot-response').innerHTML =
                        'è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                }finally {
                    // æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ¢å¤
                    sidebar.style.pointerEvents = 'auto';
                    sidebar.style.opacity = '1';
                    isProcessing = false;
                }
            }


            // åˆå§‹åŒ–
            loadFileTree();

            // ç»‘å®šå›è½¦äº‹ä»¶
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
        });
    </script>
</head>

<body>

    <div class="container">
        <!-- å·¦ä¾§èµ„æºç®¡ç†å™¨ -->
        <div class="sidebar">
            <div class="explorer">
                <h2>OpenManusX</h2>
                <div class="file-tree"></div>
            </div>
        </div>

        <!-- ä¸­é—´å·¥ä½œåŒº -->
        <div class="workspace">
            <header class="header">
                <h4>OpenManusXæ–‡ä»¶é¢„è§ˆåŒºåŠä¿å­˜åŒºï¼</h4>
            </header>
            <div class="editor-header">
                <div class="tab active"> ç¤ºä¾‹æ–‡ä»¶</div>
            </div>
            <textarea class="code-editor" placeholder="åœ¨æ­¤è¾“å…¥ä»£ç ..."></textarea>
            <div class="toolbar" style="margin-top: 10px;left: 1580px;position: absolute;">
                <button onclick="saveFile()" class="send-btn">ä¿å­˜æ–‡ä»¶</button>
            </div>
        </div>

        <!-- å³ä¾§å¯¹è¯åŒº -->
        <div class="chat-panel">
            <div class="chat-header">
                <header class="header">
                    <h4>deepseek R1æ»¡è¡€ç‰ˆ</h4>
                </header>

            <div class="editor-header">ğŸŸ¢ å·²è¿æ¥</div>
            </div>

<!--            <div class="chat-messages">-->
<!--                <div class="message ai">æ‚¨å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œéœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Ÿ</div>-->
<!--            </div>-->
<!--            <div class="chat-input">-->
<!--                <input type="text" placeholder="è¾“å…¥æ¶ˆæ¯...">-->
<!--                <button class="send-btn" onclick="sendMessage()">å‘é€</button>-->
<!--            </div>-->

                <!-- å‰ç«¯ä¿®æ”¹ -->
                <div class="chat-messages">
                    <div class="message ai">
                        <img src="/static/robot-avatar.png" class="avatar">
                        <div class="content">æ‚¨å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œéœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Ÿ</div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
                    <button class="send-btn" onclick="sendMessage()">å‘é€</button>
                </div>
        </div>
    </div>

</body>
</html>